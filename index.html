<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Guess The Image Game - Debug Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Load React, ReactDOM, Babel, and Framer Motion from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@4.1.17/dist/framer-motion.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    /* Basic reset and styling */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #f6d365, #fda085);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    #root { width: 100%; max-width: 1200px; margin: 20px auto; }
    /* Debug panel */
    #debug-output {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 12px;
      padding: 5px;
      z-index: 1000;
    }
    /* Category Screen Styles */
    .category-screen {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      padding: 20px;
      width: 90%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .category-screen h2 { margin-bottom: 10px; }
    .cat-button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      background: #3498db;
      transition: 0.3s;
    }
    .cat-button:hover { opacity: 0.8; }
    .cat-sub { background: #7f8c8d; margin-left: 20px; }
    hr { width: 100%; }
    /* Game Screen Layout (landscape) */
    .game-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: stretch;
      gap: 20px;
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
    }
    /* Fullscreen button */
    .fullscreen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #9b59b6;
      color: #fff;
      border: none;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    .fullscreen-btn:hover { opacity: 0.8; }
    /* Left side: image */
    .game-left {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .img-wrapper {
      width: 100%;
      max-width: 600px;
      height: 80vh;
      background: #ccc;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .img-wrapper img {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }
    /* Right side: controls */
    .game-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
    }
    .score-panel { text-align: center; font-size: 18px; }
    .score-buttons, .navigation-buttons { display: flex; gap: 10px; }
    .score-btn, .nav-btn {
      border: none;
      border-radius: 8px;
      font-size: 16px;
      padding: 12px;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
    }
    .score-btn:hover, .nav-btn:hover { opacity: 0.8; }
    .sofia-btn { background-color: #f39c12; }
    .matija-btn { background-color: #3498db; }
    .skip-btn { background-color: #7f8c8d; }
    .back-btn { background-color: #e74c3c; }
    .winner { font-size: 20px; font-weight: bold; color: #d35400; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="debug-output"></div>
  
  <script type="text/babel">
    // Debug logger: logs to console and appends messages to the debug panel
    function debugLog(message) {
      console.log(message);
      const debugOutput = document.getElementById("debug-output");
      if (debugOutput) {
        const p = document.createElement("p");
        p.textContent = message;
        debugOutput.appendChild(p);
      }
    }
    
    // Global error handlers
    window.onerror = function(message, source, lineno, colno, error) {
      debugLog(`Window Error: ${message} at ${source}:${lineno}:${colno}`);
    };
    window.onunhandledrejection = function(event) {
      debugLog(`Unhandled promise rejection: ${event.reason}`);
    };

    const { useState, useEffect } = React;
    // Use Framer Motion from the jsDelivr-loaded global
    const { motion, AnimatePresence } = window.FramerMotion || {};
    if (!motion || !AnimatePresence) {
      debugLog("Error: FramerMotion is not loaded properly.");
    } else {
      debugLog("FramerMotion loaded successfully.");
    }

    debugLog("Starting App...");

    const TOTAL_ROUNDS = 10;
    const UNSPLASH_ACCESS_KEY = "1-SnSlQgPjJHmFfy1v5K3Xqm9cWXIk7xkGq5nILLFW0";
    
    // Toggle fullscreen mode
    function toggleFullScreen() {
      debugLog("Toggling Fullscreen...");
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen?.(); 
      } else {
        document.exitFullscreen?.();
      }
    }

    function App() {
      const [screen, setScreen] = useState("category");
      const [selectedCategory, setSelectedCategory] = useState("");
      debugLog("App rendered. Screen: " + screen);

      const handleCategoryClick = (category) => {
        debugLog("Category clicked: " + category);
        setSelectedCategory(category);
        setScreen("game");
      };

      return (
        <div>
          <AnimatePresence mode="wait">
            {screen === "category" && (
              <motion.div
                key="categoryScreen"
                className="category-screen"
                initial={{ opacity: 0, y: 50 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -50 }}
                transition={{ duration: 0.4 }}
              >
                <h2>Odaberite Kategoriju</h2>
                <button className="cat-button" onClick={() => handleCategoryClick("animals")}>
                  Životinje (general)
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("domestic animals")}>
                  Životinje - Domaće
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("wild animals")}>
                  Životinje - Divlje
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("farm animals")}>
                  Životinje - Farma
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("sea life")}>
                  Životinje - Morske
                </button>
                <hr />
                <button className="cat-button" onClick={() => handleCategoryClick("nature")}>
                  Priroda
                </button>
                <hr />
                <button className="cat-button" onClick={() => handleCategoryClick("occupations jobs")}>
                  Zanimanja (general)
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("pilot job")}>
                  Zanimanja - Pilot
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("doctor job")}>
                  Zanimanja - Doktor
                </button>
                <button className="cat-button cat-sub" onClick={() => handleCategoryClick("policeman police")}>
                  Zanimanja - Policajac
                </button>
                <hr />
                <button className="cat-button" onClick={() => handleCategoryClick("people face expressions")}>
                  Ljudske emocije (Faces)
                </button>
              </motion.div>
            )}

            {screen === "game" && (
              <GameScreen
                key="gameScreen"
                category={selectedCategory}
                onBack={() => {
                  debugLog("Returning to category screen");
                  setScreen("category");
                  setSelectedCategory("");
                }}
              />
            )}
          </AnimatePresence>
        </div>
      );
    }

    function GameScreen({ category, onBack }) {
      const [round, setRound] = useState(0);
      const [sofiaScore, setSofiaScore] = useState(0);
      const [matijaScore, setMatijaScore] = useState(0);
      const [imageUrls, setImageUrls] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [winner, setWinner] = useState("");

      debugLog("GameScreen mounted for category: " + category);

      useEffect(() => {
        debugLog("Fetching images for category: " + category);
        fetchImages(category, TOTAL_ROUNDS).then((urls) => {
          debugLog("Fetched " + (urls ? urls.length : 0) + " images");
          setImageUrls(urls || []);
          setRound(0);
          setCurrentIndex(0);
          setWinner("");
        });
      }, [category]);

      useEffect(() => {
        debugLog("Round: " + round + ", CurrentIndex: " + currentIndex);
        if (round > TOTAL_ROUNDS || currentIndex >= imageUrls.length) {
          debugLog("Game over condition met");
          declareWinner();
        }
      }, [round, currentIndex, imageUrls]);

      const handleNext = (scoreFor) => {
        debugLog("handleNext called; scoring for: " + scoreFor);
        if (!winner) {
          setRound((r) => r + 1);
          if (scoreFor === "sofia") setSofiaScore((s) => s + 1);
          if (scoreFor === "matija") setMatijaScore((m) => m + 1);
          setCurrentIndex((idx) => idx + 1);
        }
      };

      const handleSkip = () => {
        debugLog("handleSkip called");
        if (!winner) {
          setRound((r) => r + 1);
          setCurrentIndex((idx) => idx + 1);
        }
      };

      const declareWinner = () => {
        if (winner) return;
        let result = "";
        if (sofiaScore > matijaScore) result = "Pobjednik je Sofia!";
        else if (matijaScore > sofiaScore) result = "Pobjednik je Matija!";
        else result = "Nerešeno!";
        debugLog("Winner declared: " + result);
        setWinner(result);
      };

      const currentImage = imageUrls[currentIndex] || "";
      debugLog("Current image index: " + currentIndex);

      return (
        <motion.div
          className="game-container"
          initial={{ opacity: 0, x: 100 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, x: -100 }}
          transition={{ duration: 0.5 }}
        >
          <button className="fullscreen-btn" onClick={toggleFullScreen}>
            Fullscreen
          </button>
          <div className="game-left">
            <div className="img-wrapper">
              {currentImage ? (
                <motion.img
                  key={currentImage}
                  src={currentImage}
                  alt="Current"
                  initial={{ scale: 0.9, opacity: 0 }}
                  animate={{ scale: 1, opacity: 1 }}
                  exit={{ scale: 0.9, opacity: 0 }}
                  transition={{ duration: 0.4 }}
                  onError={(e) => debugLog("Image load error: " + e.target.src)}
                  onLoad={(e) => debugLog("Image loaded: " + e.target.src)}
                />
              ) : (
                <p>Loading...</p>
              )}
            </div>
          </div>
          <div className="game-right">
            <div className="score-panel">
              Runda: {round}/{TOTAL_ROUNDS} <br />
              Sofia: {sofiaScore} | Matija: {matijaScore}
            </div>
            {!winner && (
              <>
                <div className="score-buttons">
                  <button className="score-btn sofia-btn" onClick={() => handleNext("sofia")}>
                    +1 Sofia
                  </button>
                  <button className="score-btn matija-btn" onClick={() => handleNext("matija")}>
                    +1 Matija
                  </button>
                </div>
                <div className="navigation-buttons">
                  <button className="nav-btn skip-btn" onClick={handleSkip}>
                    Next (Skip)
                  </button>
                  <button className="nav-btn back-btn" onClick={onBack}>
                    Back
                  </button>
                </div>
              </>
            )}
            {winner && (
              <div style={{ textAlign: "center" }}>
                <p className="winner">{winner}</p>
                <button className="nav-btn back-btn" onClick={onBack}>
                  Nazad
                </button>
              </div>
            )}
          </div>
        </motion.div>
      );
    }

    async function fetchImages(query, count) {
      const url = `https://api.unsplash.com/photos/random?query=${encodeURIComponent(query)}&count=${count}&client_id=${UNSPLASH_ACCESS_KEY}`;
      debugLog("Fetching images from Unsplash: " + url);
      try {
        const res = await fetch(url);
        if (!res.ok) {
          debugLog("Unsplash fetch error: " + res.statusText);
          return [];
        }
        const data = await res.json();
        debugLog("Received " + data.length + " images");
        return data.map((item) => item.urls.regular);
      } catch (err) {
        debugLog("Fetch error: " + err);
        return [];
      }
    }

    const rootEl = document.getElementById("root");
    ReactDOM.createRoot(rootEl).render(<App />);
  </script>
</body>
</html>